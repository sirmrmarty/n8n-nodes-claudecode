# First, make sure you're in the right place
pwd
whoami

# Install the n8n custom node from git repo
echo "Installing n8n-nodes-claudecode from git..."
mkdir -p /home/node/.n8n/custom
cd /home/node/.n8n/custom
git clone https://github.com/sirmrmarty/n8n-nodes-claudecode.git
cd n8n-nodes-claudecode
npm install
./install-to-n8n.sh

# Install Claude Code CLI locally (no root needed)
echo "Installing Claude Code CLI locally..."
cd /home/node
mkdir -p .local/bin .local/lib/node_modules

# Install in user's local directory
npm install --prefix /home/node/.local @anthropic-ai/claude-code

# Create a direct executable link
ln -sf /home/node/.local/node_modules/.bin/claude /home/node/.local/bin/claude

# Make it executable and add to PATH
chmod +x /home/node/.local/bin/claude
export PATH="/home/node/.local/bin:$PATH"

# Test the installations
echo "Testing installations..."
echo "1. Custom node installed:"
# Check both possible locations
if [ -d "/home/node/.n8n/custom/n8n-nodes-claudecode" ]; then
    ls -la /home/node/.n8n/custom/n8n-nodes-claudecode/ && echo "✅ Custom node found"
else
    ls -la ~/.n8n/custom/n8n-nodes-claudecode/ 2>/dev/null && echo "✅ Custom node found" || echo "❌ Custom node not found"
fi

echo "2. Claude CLI installed:"
/home/node/.local/bin/claude --version 2>/dev/null && echo "✅ Claude CLI working" || echo "❌ Claude CLI not working"

echo "Installation complete!"


# Add to your shell profile so claude command works in future sessions
echo 'export PATH="/home/node/.local/bin:$PATH"' >> /home/node/.profile
echo 'export PATH="/home/node/.local/bin:$PATH"' >> /home/node/.bashrc

# Source it for current session
source /home/node/.profile

# Test that 'claude' command works directly
claude --version
